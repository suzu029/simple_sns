{% for post in posts %}
    <div>
      <p>
        <strong>{{ post.user.username }}</strong>
        {% if post.associated_group != 'N' %}
            <span style="font-size: small; color: green; margin-left: 10px;">
                [対象: {{ post.get_associated_group_display }}]
            </span>
        {% endif %}
      </p>
      
      <p>{{ post.content }}</p>
      {% if post.image %}
        <img src="{{ post.image.url }}"
             id="post-image-{{ post.id }}" 
             data-post-id="{{ post.id }}" 
             style="cursor: pointer;">
      {% endif %}
      <p>❤️ <span id="like-count-{{ post.id }}">{{ post.total_likes }}</span> いいね</p>

      <form action="{% url 'like_post' post.id %}" method="post" class="like-form" data-post-id="{{ post.id }}" style="display: inline;">
        {% csrf_token %}
        {% if user in post.likes.all %}
          <button type="submit" id="like-button-{{ post.id }}">いいね解除</button>
        {% else %}
          <button type="submit" id="like-button-{{ post.id }}">いいね</button>
        {% endif %}
      </form>
      <hr>
    </div>
  {% endfor %}

  {% if user.is_authenticated %}
<script>
    // CSRFトークンを取得するヘルパー関数
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                let cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    // Ajaxでいいね/いいね解除を行う共通関数
    function toggleLike(postId) {
        const url = `{% url 'like_post' 999999 %}`.replace('999999', postId);
        const csrfToken = getCookie('csrftoken');

        fetch(url, {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrfToken,
                'Content-Type': 'application/json',
                'X-Requested-With': 'XMLHttpRequest'
            },
            body: JSON.stringify({})
        })
        .then(response => {
            if (!response.ok) {
                // HTTPエラー（404, 500など）
                throw new Error('Network response was not ok');
            }
            return response.json();
        })
        .then(data => {
            if (data.status === 'ok') {
                // DOMを更新
                const likeCountElement = document.getElementById(`like-count-${postId}`);
                const likeButtonElement = document.getElementById(`like-button-${postId}`);
                
                if (likeCountElement) {
                    likeCountElement.textContent = data.total_likes;
                }
                
                if (likeButtonElement) {
                    // ボタンのテキストを更新
                    if (data.is_liked) {
                        likeButtonElement.textContent = 'いいね解除';
                    } else {
                        likeButtonElement.textContent = 'いいね';
                    }
                }
            } else {
                console.error('いいねの更新に失敗しました:', data);
                alert('いいねの更新に失敗しました。');
            }
        })
        .catch(error => {
            console.error('通信エラー:', error);
            alert('いいねの更新中にエラーが発生しました。');
        });
    }

    document.addEventListener('DOMContentLoaded', function() {
        // 1. フォーム送信イベントの処理 (いいねボタン)
        const likeForms = document.querySelectorAll('.like-form');
        likeForms.forEach(form => {
            form.addEventListener('submit', function(event) {
                event.preventDefault(); // フォームの通常の送信（ページリロード）をキャンセル
                const postId = this.getAttribute('data-post-id');
                if (postId) {
                    toggleLike(postId);
                }
            });
        });

        // 2. 画像ダブルクリックイベントの処理 (既存の処理をAjaxに変更)
        const postImages = document.querySelectorAll('[id^="post-image-"]');
        postImages.forEach(image => {
            image.addEventListener('dblclick', function() {
                const postId = this.getAttribute('data-post-id');
                if (postId) {
                    toggleLike(postId);
                }
            });
        });
    });
</script>
{% endif %}