{% extends "base.html" %}

{% block content %}
  {% load static %}
  
  {% if user.is_authenticated %}
    <p>
      <a href="{% url 'post_create' %}" style="
          display: inline-block;
          background-color: #3498db;
          color: white;
          padding: 10px 15px;
          border-radius: 5px;
          text-decoration: none;
          margin-bottom: 20px;
          font-weight: bold;
      ">
        新規投稿
      </a>
    </p>

    <div style="margin-bottom: 20px; padding: 10px; border: 1px solid #e0e0e0; border-radius: 8px; background-color: #f9f9f9; box-shadow: 0 1px 3px rgba(0,0,0,0.05);">
        <h3 style="margin-top: 0; color: #1abc9c; font-size: 1.2em;">現在のいいね集計</h3>
        <p style="margin: 5px 0;">
            <strong>全体総数:</strong> <span id="total-all-likes">{{ total_group_a_likes | add:total_group_b_likes }}</span> いいね
        </p>
        <p style="margin: 5px 0; color: #3499db;">
            <strong id="group-a-name-summary">{{ group_a_display_name }}</strong>: <span id="total-group-a-likes">{{ total_group_a_likes }}</span> いいね
        </p>
        <p style="margin: 5px 0; color: #e74c3c;">
            <strong id="group-b-name-summary">{{ group_b_display_name }}</strong>: <span id="total-group-b-likes">{{ total_group_b_likes }}</span> いいね
        </p>
    </div>
    {% endif %}

  {% for post in posts %}
    <div>
      <p>
        <strong>{{ post.user.username }}</strong>
        {% if post.associated_group != 'N' %}
            <span style="font-size: small; color: green; margin-left: 10px;">
                [対象: {{ post.get_associated_group_display }}]
            </span>
        {% endif %}
      </p>
      
      <p>{{ post.content }}</p>
{% if post.image %}
        <img src="{{ post.image.url }}"
             id="post-image-{{ post.id }}" 
             data-post-id="{{ post.id }}" 
             style="cursor: pointer; max-width: 100% !important; height: auto !important; width: 100% !important;"> {% endif %}
      <p>❤️ <span id="like-count-{{ post.id }}">{{ post.total_likes }}</span> いいね</p>

      <form action="{% url 'like_post' post.id %}" method="post" class="like-form" data-post-id="{{ post.id }}" style="display: inline;">
        {% csrf_token %}
        {% if user in post.likes.all %}
          <button type="submit" id="like-button-{{ post.id }}">いいね解除</button>
        {% else %}
          <button type="submit" id="like-button-{{ post.id }}">いいね</button>
        {% endif %}
      </form>
      <hr>
    </div>
  {% endfor %}

  {% if user.is_authenticated %}
<script>
    // CSRFトークンを取得するヘルパー関数
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                let cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    // Ajaxでいいね/いいね解除を行う共通関数
    function toggleLike(postId) {
        // postIdをURLに挿入するために、ダミーのID (999999) を使用してURLを生成
        const url = `{% url 'like_post' 999999 %}`.replace('999999', postId);
        const csrfToken = getCookie('csrftoken');

        fetch(url, {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrfToken,
                'Content-Type': 'application/json',
                'X-Requested-With': 'XMLHttpRequest'
            },
            // POSTリクエストだが、ボディは空でOK
            body: JSON.stringify({})
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            return response.json();
        })
        .then(data => {
            if (data.status === 'ok') {
                // 1. 個別のいいね数を更新
                const likeCountElement = document.getElementById(`like-count-${postId}`);
                const likeButtonElement = document.getElementById(`like-button-${postId}`);
                
                if (likeCountElement) {
                    likeCountElement.textContent = data.total_likes;
                }
                
                if (likeButtonElement) {
                    // ボタンのテキストを更新
                    if (data.is_liked) {
                        likeButtonElement.textContent = 'いいね解除';
                    } else {
                        likeButtonElement.textContent = 'いいね';
                    }
                }

                // 2. 全体のいいね集計を更新
                const totalGroupA = document.getElementById('total-group-a-likes');
                const totalGroupB = document.getElementById('total-group-b-likes');
                const totalAll = document.getElementById('total-all-likes');

                if (totalGroupA && data.total_group_a_likes !== undefined) {
                    totalGroupA.textContent = data.total_group_a_likes;
                }
                if (totalGroupB && data.total_group_b_likes !== undefined) {
                    totalGroupB.textContent = data.total_group_b_likes;
                }
                if (totalAll && data.total_group_a_likes !== undefined && data.total_group_b_likes !== undefined) {
                    // JavaScriptで足し算を実行して全体総数を更新
                    totalAll.textContent = data.total_group_a_likes + data.total_group_b_likes;
                }
                
            } else {
                console.error('いいねの更新に失敗しました:', data);
                alert('いいねの更新に失敗しました。');
            }
        })
        .catch(error => {
            console.error('通信エラー:', error);
            alert('いいねの更新中にエラーが発生しました。');
        });
    }

    document.addEventListener('DOMContentLoaded', function() {
        // 1. フォーム送信イベントの処理 (いいねボタン)
        const likeForms = document.querySelectorAll('.like-form');
        likeForms.forEach(form => {
            form.addEventListener('submit', function(event) {
                event.preventDefault(); // フォームの通常の送信（ページリロード）をキャンセル
                const postId = this.getAttribute('data-post-id');
                if (postId) {
                    toggleLike(postId);
                }
            });
        });

        // 2. 画像ダブルクリックイベントの処理 
        const postImages = document.querySelectorAll('[id^="post-image-"]');
        postImages.forEach(image => {
            image.addEventListener('dblclick', function() {
                const postId = this.getAttribute('data-post-id');
                if (postId) {
                    toggleLike(postId);
                }
            });
        });
    });
</script>
{% endif %}
{% endblock %}